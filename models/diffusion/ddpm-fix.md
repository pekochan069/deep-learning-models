# DDPM 디버그 TODO (Markdown 체크 포함)

## 1) 핵심 버그 수정 TODO (반드시 먼저)

* [ ] **샘플링 업데이트식 교정**

  * [x] `predict()`에서 \*\*누적값 `√ᾱ_t`가 아닌 현재 스텝의 `α_t`\*\*를 사용하도록 수정
  * [x] 노이즈 항을 \*\*`z * √β_t` (또는 posterior 분산 `√\tilde{β}_t`)\*\*로 교체
  * [ ] 평균도 **posterior mean `μ_t`**(Ho 논문 고정 분산 기준)로 계산하도록 정식 적용
* [ ] **스텝 스킵 시 식 일치화**

  * [x] (안전) 먼저 **풀스텝(1000)** DDPM 샘플링으로 정상 동작 검증
  * [ ] (가속) 스텝을 줄일 때는 **DDIM 식**으로 `x0_hat`, `ᾱ_{t_i}→ᾱ_{t_{i-1}}` 전이 적용
* [x] **`steps >= max_t` 금지 로직 제거**

  * [x] `steps == max_t`를 허용해 **1000스텝 샘플링** 가능하게 수정
* [x] **SinusoidalPositionalEmbedding 사소 버그**

  * [x] `__init__`에서 `self.base = base` 저장 (실수 분기에서 사용)

---

## 2) 디버깅 & 검증 체크리스트

* [ ] **1000스텝 샘플 품질 확인** (최초 교정 후 숫자 형상 유무 확인)
* [ ] **중간 시점 복원 시각화**

  * [ ] 임의 `t`들에 대해 `x_t` 생성 → `ε̂`로 **`x0_hat = (x_t - √(1-ᾱ_t)·ε̂)/√ᾱ_t`** 복원 그림 확인
* [ ] **소데이터 과적합 테스트**

  * [ ] 수백\~천 장 서브셋으로 **완전 과적합** 가능 여부 확인(불가능하면 아직 핵심식/학습 설정 이슈)
* [ ] **손실 기록 스케일 점검**

  * [ ] `train/val loss`를 **배치 평균**으로 로깅해 epoch 간 비교 일관화
* [ ] **데이터 정규화 일치**

  * [ ] 학습 입력 스케일(\[0,1] 또는 \[-1,1])과 **샘플링 후 후처리**가 일치하는지 확인
* [ ] **CFG 경로 검증**

  * [ ] `ε̂ = ε̂_uncond + s·(ε̂_cond − ε̂_uncond)` 정확 적용
  * [ ] `null_token` 주입, `guidance_scale` 1.5\~3.0 **감도 테스트**
* [ ] **로그 보강**

  * [ ] `t` 분포별 MSE, `x0_hat` PSNR/SSIM, 샘플 그리드 주기 저장

---

## 3) 학습/안정화 개선 TODO (버그 fix 후 적용)

* [x] **학습률 낮추기**: `lr = 1e-4`부터 시도(+ 워밍업/코사인 스케줄 고려)
* [ ] **훈련 스텝 대폭 증가**: 손실 평탄 이후에도 **장시간 추가 학습** 및 샘플 주기 모니터링
* [ ] **EMA 적용**: 학습 중 EMA 가중치 유지, **샘플은 EMA 파라미터**로 생성
* [ ] **β 스케줄/목표식 변형 실험**: 선형 → **cosine β**, **SNR 가중**, **v-prediction** 검토
* [ ] **Early Stopping 완화/비활성**: val\_loss만 의존 X, **샘플 품질 기준** 병행
* [ ] **검증 정책 정합**: 학습 시 `cfg_unconditional_prob` 사용 시, 검증/샘플링 정책 일관성 확정
* [ ] **정규화 점검**: GroupNorm 그룹 수/채널 수 일치 및 일관 유틸(`gn_groups`) 적용

---

## 4) 추가로 넣으면 좋은 것들

* [ ] **샘플러 옵션화**: DDPM / DDIM(η) / Heun / DPM-Solver 스위치
* [ ] **평가 자동화**: 생성 그리드 저장 + 간단한 MNIST 분류기로 **가짜 이미지 분류 정확도** 측정
* [ ] **모니터링 지표**: `t`-wise MSE, `x0_hat` PSNR/SSIM, CFG 스케일별 품질 로그
* [ ] **데이터 처리**: 28→32 **resize 대체** 또는 패딩 영역 약한 증강으로 **배경 치우침 완화**
* [ ] **코드 가드**: shape/dtype assert, `t∈[0,T)` 체크, 버퍼 디바이스 일치 검사
* [ ] **스텝 프리셋**: 1000/250/100/50/20 (각각에 맞는 `t_space`+업데이트식 세트화)

---

## 5) 실행 순서(체크리스트)

1. [ ] **샘플링식 교정**(α\_t/μ\_t/√β\_t or √\tilde{β}\_t)
2. [ ] **`steps == max_t` 허용** 후 **1000스텝 샘플**로 기본 동작 확인
3. [ ] **중간 복원/과적합/스케일/정규화/CFG** 점검
4. [ ] **lr=1e-4**로 재학습 + **스텝 대폭 증가**
5. [ ] **EMA 샘플링** 적용
6. [ ] **DDIM 가속 샘플러** 및 **평가/모니터링** 확장
